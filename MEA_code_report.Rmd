---
title: "Analysis of MEA data"
author: "Federico Men√©ndez Conde"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("funciones_para_MEA.R")
library(dplyr)
library(ggplot2)
library(knitr)
```

For each video, six regions of interest (roi) are considered. Three for each subject (patient and therapist): head, torso and legs. The exploratory analysis is done in two parts:

1) In the first part, we look for 5 minutes segments with high lagged correlation for some roi.
2) In the second part, we look for 30 second periods with high movement of both subjects. Cross correlations are performed and visualized for those high movement periods. 


### First part


```{r, include=FALSE}
zonas <- c("cabeza","torso","piernas")
rois <- c(paste(zonas,"paciente",sep="_"),paste(zonas,"terapeuta",sep="_"))
bitacora <- read.csv("bitacora_mea.csv",encoding = "UTF-8")
minutos_particion <- 5
```

Basic information of the `r dim(bitacora)[1]` videos is registered in table _bitacora_. Here we show the top entries of this table.   

```{r bitacora, echo=FALSE}
cuantos=5
kable(head(bitacora,cuantos))
```


```{r completa, include=FALSE}
completa <- list()

for (v in 1:length(bitacora$file)){
    video <- paste(bitacora$file[v],".txt",sep="")
    first_cut <- (bitacora$sampling_rate[v])*(bitacora$corte_inicial[v])
    last_cut <- (bitacora$sampling_rate[v])*(bitacora$corte_final[v])
    x <- arma_base(video,first_cut,last_cut)
    nombre <- substr(video,1,nchar(video)-4)
    path <- paste("bases_videos_csv/",nombre,".csv",sep = "")
    write.csv(x,path,row.names = FALSE)
    completa[[bitacora$file[v]]] <- x
}
```

The list _completa_ contains the data for each of the videos listed in _bitacora_. As an example, _completa[['Vid5']]_ is a data set with `r nrow(completa[['Vid5']])` observations. At a sampling rate of 30 frames per second, this corresponds to 
`r round(nrow(completa[['Vid5']])/(30*60),2)` minutes for the video _Vid5_. Its first entries are shown below.

```{r, echo=FALSE}
kable(head(completa[['Vid5']],10),caption='Top entries for Vid5 raw data.')
```

The code below generates the database _lista_seleccionados_. This contains information on segments where high correlation (with time lags) between the movements of the subjects is detected. Each of the videos in _bitacora_ is partiotioned in `minutos_particion` minutes segments. For each segment and roi, cross correlations (wuth 3 seconds max-lags in both directions) between therapist and subject movements are performed; the maximum and the mean values for the correlations for all the lags are recorded; if either the max>0.7 or mean>0.3 the segment is added to the list. If the maximum correlation corresponds to lag 0, the segment is discarded (simultaneous movement), since the correlation in this case is most likely due to external noise.   

```{r, echo=TRUE}
lista_seleccionados<-data.frame(matrix(ncol = 10,nrow = 0))

for (video in names(completa)){
      temp <- crear_lista(partition_data(completa[[video]]),
                          nombre = video,umbral_max = 0.7,umbral_mean = 0.5)
      names(lista_seleccionados)<-names(temp)
      lista_seleccionados<-rbind(lista_seleccionados,temp)
}

lista_seleccionados<-cbind(id=1:dim(lista_seleccionados)[1],lista_seleccionados)
lista_seleccionados<-filter(lista_seleccionados,abs(lag_spearman_max)>0.025)

write.csv(lista_seleccionados,"lista_seleccionados.csv",row.names = FALSE)
```

```{r}
kable(lista_seleccionados,caption="Five minute segments with high lagged correlation. Lags are shown in seconds, with positive values corresponding to lags where the therapist leads.")
```



We include two functions functions _comparativa_visual_ and _corr_cruzadas_ for visualizing the data of the segments with high correlation. The fundamental input for both functions is the number in the _id_ column of _lista_seleccionados_.

```{r echo=FALSE}
comparativa_visual
corr_cruzadas
```

The function _comparativa_visual_ produces a plot that shows the movement of both therapist and patient for the corresponding segment and roi. We generate below the plots generated by this function for all the `nrow(lista_seleccionados)` segments with high correlation. 

```{r echo=FALSE}
for (i in lista_seleccionados$id){
  comparativa_visual(i)
}
```

The function _corr_cruzadas_ shows the cross correlation between movements of both subjects at lags of up to 3 seconds (in both directions). The plots are generated below.

```{r echo=FALSE}
for (i in lista_seleccionados$id){
  corr_cruzadas(i)
}
```
