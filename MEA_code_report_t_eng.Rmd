---
title: "Transversal Analysis of MEA data."
author: "Federico Men√©ndez Conde"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("MEA_functions.R")
library(dplyr)
library(ggplot2)
library(knitr)
```

```{r, include=FALSE,echo=FALSE}
zones <- c("head","torso","legs")
rois <- c(paste(zones,"patient",sep="_"),paste(zones,"therapist",sep="_"))
logbook <- read.csv("logbook_first_sessions.csv",encoding = "UTF-8")
minutes_particion <- 5
```


The MEA data obtained from videos of therapy sessions is analysed. All `r ncol(logbook)` videos correspond to the first session with a different patient.  In each case, six regions of interest (ROI) are considered, three for each subject (patient and therapist): head, torso and legs. The exploratory analysis is done in two parts:



1) In the first part, each video is partitioned into `r minutes_particion` minutes segments. Lagged correlations (for five seconds in each direction) are performed in order to detect in which of these segments there exists a high correlation (either positive or negative) between the movements of therapist and patient, for the same ROI. 


2) In the second part, the videos are partitioned into much shorter periods (30 seconds). The ones with high movement of both subjects and the same ROI are registered. Cross correlations are performed and visualized for those registered periods. 


### First part. 


```{r completa, include=FALSE}
completa <- list()

for (v in 1:length(logbook$file)){
    video <- paste(logbook$file[v],".txt",sep="")
    first_cut <- (logbook$sampling_rate[v])*(logbook$inicial_cut[v])
    last_cut <- (logbook$sampling_rate[v])*(logbook$final_cut[v])
    x <- arma_base(video,first_cut,last_cut)
    nombre <- substr(video,1,nchar(video)-4)
    path <- paste("bases_videos_csv/",nombre,".csv",sep = "")
    write.csv(x,path,row.names = FALSE)
    completa[[logbook$file[v]]] <- x
}

temp<-list()
for(j in names(completa)){
    print(j)
    temp<-c(temp,nrow(completa[[j]]))
}
print(length(temp))
```

Basic information of the `r dim(logbook)[1]` videos is registered in table _logbook_. Here we show the top entries of this table.   

```{r logbook, echo=FALSE}
cuantos=5
kable(head(logbook,cuantos))
```

The list _completa_ contains the data for each of the videos listed in _logbook_. As an example, _completa[['Vid5']]_ is a data set with `r nrow(completa[['Vid5']])` observations. At a sampling rate of 30 frames per second, this corresponds to 
`r round(nrow(completa[['Vid5']])/(30*60),2)` minutes for the video _Vid5_. Its first entries are shown below.

```{r, echo=FALSE}
kable(head(completa[['Vid5']]),caption='Top entries for Vid5 raw data.')
```

The code below generates the database _selected_lapses_. This contains information on segments where high correlation (with time lags) between the movements of the subjects is detected. Each of the videos in _logbook_ is partiotioned in `r minutes_particion` minutes segments. For each segment and roi, cross correlations (wuth 3 seconds max-lags in both directions) between therapist and subject movements are performed; the maximum and the mean values for the correlations for all the lags are recorded; if either the max>0.7 or mean>0.3 the segment is added to the list. If the maximum correlation corresponds to lag 0, the segment is discarded (simultaneous movement), since the correlation in this case is most likely due to external noise.   

```{r, echo=TRUE}
selected_lapses<-data.frame(matrix(ncol = 12,nrow = 0))

for (video in names(completa)){
  print(video)
  temp <- crear_lista(partition_data(completa[[video]]),
                      nombre = video,umbral_max = 0.7,umbral_mean = 0.5,
                      segundos = 60*minutes_particion)
  names(selected_lapses)<-names(temp)
  selected_lapses<-rbind(selected_lapses,temp)
}

selected_lapses<-cbind(id=1:dim(selected_lapses)[1],selected_lapses)
selected_lapses<-filter(selected_lapses,abs(lag_spearman_max)>0.025)

write.csv(selected_lapses,"selected_lapses.csv",row.names = FALSE)
```

```{r echo=FALSE}
kable(selected_lapses,caption="Three minute segments with high lagged correlation. Lags are shown in seconds, with positive values corresponding to lags where the therapist leads.")
```


We include two functions functions _comparativa_visual_ and _corr_cruzadas_ for visualizing the data of the segments with high correlation. The fundamental input for both functions is the number in the _id_ column of _selected_lapses_.

```{r echo=FALSE}
comparativa_visual
corr_cruzadas
```

The function _comparativa_visual_ returns a plot that shows the movement of both therapist and patient for the corresponding segment and roi. The data is smoothed by teking the average movements in 1 second windows. We generate below the plots generated by this function for all the `r nrow(selected_lapses)` segments with high correlation. 

```{r echo=FALSE}
for (i in selected_lapses$id){
  comparativa_visual(i)
}
```

The function _corr_cruzadas_ shows the cross correlation between movements of both subjects at lags of up to 3 seconds (in both directions). The plots are generated below.

```{r echo=FALSE}
for (i in selected_lapses$id){
  corr_cruzadas(i)
}
```


With the function _comparativa_visual_ we can zoom in to look into shorter periods of time. As an example, we generate the plot of the first segment (id=1) from minute 7.1 to minute 8.6:

```{r}
comparativa_visual(id=1,min_ini = 7.1,min_fin = 8.6)
```

## Part 2: exploring short lapses with high movement.

```{r echo=FALSE}
d = 0.5
quantile = 0.85
```

Videos are partitioned into `r 60*d` second segments. The mean amounts of movement for each roi are calculated (as recorded by the MEA software). If the means of both the therapist and patient are in the top `r 100-100*quantile` quantile, the corresponding data for that roi and time is registered in the list _lista_mov_altos_. 


```{r echo=FALSE}
lista_mov_altos <- data.frame(matrix(ncol = 15,nrow = 0))  
#colnames(lista_mov_altos) <- c("video","zone","minute_inicio","minute_final",
#                        "mov_patient","mov_therapist","mov_medio")

for (v in names(completa)){
    lista_mov_altos <- rbind(lista_mov_altos,
          crea_lista_movs(partition_data(completa[[v]],minutes=d),nombre_video = v,q=quantile))    
}

lista_mov_altos<-filter(lista_mov_altos,abs(lag_spearman_max)>0.1)

write.csv(lista_mov_altos,"lista_mov_altos.csv",row.names = FALSE)

ids <- data.frame(id=1:nrow(lista_mov_altos))
lista_mov_altos<-cbind(ids,lista_mov_altos)

lista_mov_altos$se_mueve_mas = "-"

for (k in 1:nrow(lista_mov_altos)){
  if (lista_mov_altos$mov_patient[k]>1.1*(lista_mov_altos$mov_therapist[k])){
      lista_mov_altos$se_mueve_mas[k]="patient"
  }    
  if (lista_mov_altos$mov_patient[k]< 0.9*(lista_mov_altos$mov_therapist[k])){
      lista_mov_altos$se_mueve_mas[k]="therapist"    
  }
}

```

Below, we show the database _lista_mov_altos_ containing `r nrow(lista_mov_altos)` segments having high mobility for both subjects. Cross correlations were evaluated and registered for each of these segments. To determine which subject is leading, the sign og the lag with maximum correlation is considered (positive when therapist leads). 

```{r, echo=FALSE}
kable(lista_mov_altos)
```

The functions _comparativa_visual_ and _corr_cruzadas_ can be used here for the segments registered in _lista_mov_altos_ for visualization. 

We illustrate this, with the ten segments with highest max correlation, and the ten segments with larger movements.

First, for the top correlations:

```{r, echo=FALSE}
top10_spearman <- arrange(lista_mov_altos,desc(spearman_max))[1:10, ]
kable(top10_spearman,caption="Segments with higher correlation")
for (i in top10_spearman$id){
  comparativa_visual(i,que_lista = lista_mov_altos)
  corr_cruzadas(i,que_lista = lista_mov_altos)
}
```

And now for the segments with larger movement:

```{r, echo=FALSE}
top10_movement <- arrange(lista_mov_altos,desc(mov_medio))[1:10, ]
kable(top10_spearman,caption="Segments with larger movement")
for (i in top10_spearman$id){
  comparativa_visual(i,que_lista = lista_mov_altos)
  corr_cruzadas(i,que_lista = lista_mov_altos)
}
```

write.csv(selected_lapses,"selected_lapses.csv",row.names = FALSE)
write.csv(lista_mov_altos,"lista_mov_altos.csv",row.names = FALSE)